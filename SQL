import requests  # 引入 requests 套件，用於發送 HTTP 請求
import pyodbc  # 引入 pyodbc 套件，用於連接和操作 SQL Server 資料庫
import pandas as pd  # 引入 pandas 套件，用於數據處理和分析
from bs4 import BeautifulSoup  # 從 bs4 套件中引入 BeautifulSoup，用於解析 HTML 文檔
from TaiwanLottery import utils  # 從 TaiwanLottery 套件中引入 utils 模組（假設這是自定義的程式碼）

# 定義函式 parse_tw_lotto_html 用於解析台灣彩券的 HTML 資料
def parse_tw_lotto_html(data_Info, number_count):
    data_Info_List = []  # 創建空列表來存儲資料
    data_Info_Dict = {}  # 創建空字典來存儲格式化後的資料
    tmp_index = 0  # 設置臨時索引變數初始值為 0

    # 迭代處理傳入的資料
    for index in range(len(data_Info)):
        if index == 0:
            data_Info_List.append(data_Info[index].text)  # 將首個元素加入資料列表
        else:
            if index % number_count != 0:
                data_Info_List.append(data_Info[index].text)  # 將符合條件的元素加入資料列表
            else:
                data_Info_Dict[str(tmp_index)] = list(data_Info_List)  # 將格式化後的資料存入字典
                data_Info_List = []  # 重置資料列表
                data_Info_List.append(data_Info[index].text)  # 添加新的資料到資料列表
                tmp_index += 1  # 更新臨時索引

    data_Info_Dict[str(tmp_index)] = list(data_Info_List)  # 將最後一組資料存入字典

    return data_Info_List, data_Info_Dict  # 返回格式化後的資料列表和字典

# 定義函式 scrape_lottery_numbers 用於獲取台灣彩券的開獎號碼
def scrape_lottery_numbers():
    url = 'https://www.taiwanlottery.com/lotto/result/lotto649'  # 定義彩券網站的 URL
    response = requests.get(url)  # 發送 GET 請求並獲取響應
    response.encoding = 'utf-8'  # 設置響應的編碼格式為 UTF-8

    soup = BeautifulSoup(response.text, 'html.parser')  # 使用 BeautifulSoup 解析 HTML 文檔
    div_elements = soup.find_all('div', class_='ball_tx ball_green')  # 找到指定類型的 div 元素

    date_Info_List, data_Info_Dict = parse_tw_lotto_html(div_elements, 6)  # 調用解析函式處理獲取的 HTML 元素
    df = pd.DataFrame(data_Info_Dict)  # 將字典轉換為 pandas 的 DataFrame
    dft = df.transpose()  # 將 DataFrame 轉置，使得每行代表一組開獎號碼

    return dft  # 返回轉置後的 DataFrame

# 呼叫 scrape_lottery_numbers 函式獲取彩券號碼資料
lottery_numbers = scrape_lottery_numbers()

# 定義資料庫連接所需的相關資訊
db_server = ""  # 資料庫伺服器名稱或 IP 地址
db_database = ""  # 資料庫名稱
db_username = ""  # 資料庫用戶名
db_password = ""  # 資料庫密碼

driver_name = '{ODBC Driver 17 for SQL Server}'  # 資料庫驅動程式名稱
connection_string = f"DRIVER={driver_name};SERVER={db_server};DATABASE={db_database};UID={db_username};PWD={db_password};"  # 構建連接字串

conn = pyodbc.connect(connection_string)  # 通過 pyodbc 建立到 SQL Server 的連接
cursor = conn.cursor()  # 建立操作資料庫的游標物件

insert_query = """
INSERT INTO your_table_name (column1, column2, column3, column4, column5, column6)
VALUES (?, ?, ?, ?, ?, ?)
"""  # 定義要執行的 SQL INSERT 查詢，需根據實際表名和列名修改

# 遍歷彩券號碼的每一行，並將其插入到資料庫表中
for index, row in lottery_numbers.iterrows():
    cursor.execute(insert_query, row[0], row[1], row[2], row[3], row[4], row[5])  # 執行 INSERT 查詢，插入每行資料到資料庫表中

conn.commit()  # 提交事務，確認所有的 SQL 操作
conn.close()  # 關閉資料庫連接
